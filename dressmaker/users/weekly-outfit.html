<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Outfit | DressMate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <link rel="icon" type="image/png" href="../assets/logo.png" />

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body {
            font-family: "Poppins", sans-serif;
            background: linear-gradient(180deg, #ffeaf4 0%, #fff 100%);
            color: #333;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 182, 193, 0.5);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(255, 182, 193, 0.4);
        }

        .item-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            background-color: #f7f7f7;
            border: 1px solid #f9dae5;
            cursor: pointer;
            /* Make image clearly clickable */
        }

        .item-icon-box i {
            cursor: default;
        }

        /* Base button style */
        .action-btn {
            position: absolute;
            top: 10px;
            background: rgba(255, 255, 255, 0.8);
            color: #ec4899;
            font-size: 1rem;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0.8;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        /* Adjusted position since only delete is left */
        .delete-btn {
            right: 10px;
        }

        .card:hover .action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .card:hover .delete-btn:hover {
            color: white;
            background-color: #db2777;
        }

        /* Custom styles for the line chart container */
        #outfitChart {
            padding-top: 10px;
        }

        /* New style for the item flex container to save space */
        .item-flex-container {
            display: flex;
            gap: 0.5rem;
            /* Reduced gap */
            padding: 0.5rem;
            /* Reduced padding */
        }

        .item-icon-box {
            flex-shrink: 0;
            width: 40px;
            /* Smaller width */
            height: 40px;
            /* Smaller height */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fde8ef;
            /* Light pink background */
            color: #db2777;
            /* Darker pink icon */
        }

        /* Style for the new Pinned Table */
        #pinnedFavoritesTable {
            width: 100%;
            border-collapse: collapse;
        }

        #pinnedFavoritesTable th,
        #pinnedFavoritesTable td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #fbcfe8;
            /* Light pink border */
        }

        #pinnedFavoritesTable th {
            background-color: #ffe4e6;
            /* Very light pink header */
            color: #831843;
            /* Darker pink text */
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        #pinnedFavoritesTable tr:hover {
            background-color: #fff1f2;
        }

        .favorite-img-col {
            width: 60px;
        }

        .unfavorite-btn-table {
            background: #f43f5e;
            color: white;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }

        .unfavorite-btn-table:hover {
            background: #e11d48;
        }
    </style>
</head>

<body>
    <div class="flex-col min-h-screen">
        <header
            class="flex items-center justify-between px-6 py-4 bg-white/70 backdrop-blur-md shadow-sm fixed w-full z-50">
            <div class="flex items-center gap-3">
                <a href="./dashboard.html"
                    class="text-gray-700 hover:text-pink-600 flex items-center gap-2 transition font-medium">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </a>
                <h1 class="text-xl font-semibold text-pink-600">
                    Weekly Outfit Planner
                </h1>
            </div>
        </header>

        <main class="flex-1 flex flex-col px-6 pt-24 pb-12 max-w-7xl mx-auto">
            <section class="text-center mb-10" data-aos="fade-down">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">
                    Welcome,
                    <span id="userNameDesktop" class="text-pink-600">Loading...</span>
                    📅
                </h2>
                <p class="text-gray-600">Plan your style and visualize your usage!</p>
            </section>

            <section id="pinnedFavoritesSection" class="mb-10 hidden" data-aos="fade-up" data-aos-delay="50">
                <div class="glass p-6">
                    <h3 class="text-xl font-bold text-pink-600 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-thumbtack"></i> Pinned Favorite Outfits
                    </h3>
                    <div class="overflow-x-auto">
                        <table id="pinnedFavoritesTable"></table>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="lg:col-span-1 glass p-6 card" data-aos="fade-up" data-aos-delay="100">
                    <h3 class="text-xl font-bold text-pink-600 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-line"></i> Weekly Plan Trend
                    </h3>
                    <div id="outfitChart"></div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="glass p-6 card flex flex-col justify-center" data-aos="fade-up" data-aos-delay="200">
                        <p class="text-sm font-medium text-gray-500 mb-1">
                            Total Planned Outfits
                        </p>
                        <p id="totalOutfits" class="text-4xl font-bold text-gray-800">
                            0
                        </p>
                        <p class="text-sm text-pink-500 mt-2 flex items-center gap-1">
                            <i class="fa-solid fa-calendar-check"></i> This week's style
                            agenda.
                        </p>
                    </div>
                    <div class="glass p-6 card flex flex-col justify-center" data-aos="fade-up" data-aos-delay="300">
                        <p class="text-sm font-medium text-gray-500 mb-1">
                            Unique Items in Rotation
                        </p>
                        <p id="itemsInRotation" class="text-4xl font-bold text-gray-800">
                            0
                        </p>
                        <p class="text-sm text-pink-500 mt-2 flex items-center gap-1">
                            <i class="fa-solid fa-hand-sparkles"></i> Unique items planned.
                        </p>
                    </div>
                </div>
            </section>
            <button onclick="openOutfitForm()"
                class="mb-8 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition self-center">
                <i class="fa-solid fa-plus-circle mr-2"></i> Add New Outfit Plan
            </button>

            <section id="outfitGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full"
                data-aos="fade-up">
                <p id="outfitGridStatus" class="col-span-full text-center text-gray-500">
                    Loading outfits...
                </p>
            </section>
        </main>

        <footer class="text-center text-gray-500 text-sm py-4 mt-auto">
            © 2025 DressMate. All rights reserved.
        </footer>
    </div>

    <div id="outfitModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 w-full max-w-2xl relative shadow-2xl overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal()" class="absolute top-5 right-5 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>

            <h2 class="text-2xl md:text-3xl font-bold text-pink-600 mb-6 text-center">
                Add Outfit Plan
            </h2>

            <form id="outfitForm" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold text-gray-700 mb-1">Date</label>
                        <input id="date" type="date"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-400" required />
                    </div>

                    <div>
                        <label class="block font-semibold text-gray-700 mb-1">Outfit Name</label>
                        <input id="name" type="text" placeholder="e.g., Friday Casual"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-400" required />
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-shirt text-pink-500"></i> Upper
                            (Shirt/Jacket)
                        </h3>
                        <label class="block text-sm text-gray-600 mb-1">Image (Optional)</label>
                        <input id="upperImage" type="file" accept="image/*"
                            class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200" />
                        <label class="block text-sm text-gray-600 mb-1">Description</label>
                        <textarea id="upperDesc" placeholder="e.g., White polo shirt" rows="2"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"></textarea>
                    </div>

                    <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-person text-pink-500"></i> Pants (Bottoms)
                        </h3>
                        <label class="block text-sm text-gray-600 mb-1">Image (Optional)</label>
                        <input id="pantsImage" type="file" accept="image/*"
                            class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200" />
                        <label class="block text-sm text-gray-600 mb-1">Description</label>
                        <textarea id="pantsDesc" placeholder="e.g., Dark blue jeans" rows="2"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"></textarea>
                    </div>

                    <div class="border rounded-xl p-4 bg-pink-50 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-shoe-prints text-pink-500"></i> Shoes
                        </h3>
                        <label class="block text-sm text-gray-600 mb-1">Image (Optional)</label>
                        <input id="shoesImage" type="file" accept="image/*"
                            class="mb-3 w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-100 file:text-pink-700 hover:file:bg-pink-200" />
                        <label class="block text-sm text-gray-600 mb-1">Description</label>
                        <textarea id="shoesDesc" placeholder="e.g., White sneakers" rows="2"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-pink-400"></textarea>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="button" id="saveOutfitButton" onclick="saveOutfit()"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 rounded-full shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-save"></i> Save Outfit Plan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init();
        let outfitLineChart = null;

        // *** ENHANCED viewLargeImage FUNCTION for better visual appeal ***
        window.viewLargeImage = function (imageUrl, altText) {
            if (!imageUrl) return;

            Swal.fire({
                // Minimal, clean title
                title: altText,
                html: `<img src="${imageUrl}" style="max-width: 100%; max-height: 80vh; object-fit: contain;" alt="${altText}">`,
                // Set imageUrl to null and use html to control the style and size better
                imageUrl: null,
                imageAlt: altText,
                width: "90%", // Larger width for desktop/mobile
                showConfirmButton: false,
                showCloseButton: true,
                padding: "1.5rem",
                // Modern, slightly transparent background
                background: "rgba(255, 255, 255, 0.98)",
                // Darker, blurrier backdrop
                backdrop: "rgba(0,0,0,0.8) blur(5px)",
                customClass: {
                    // Remove default image class padding/style
                    image: "hidden",
                    // Ensure a smooth, rounded look
                    popup: "rounded-2xl shadow-2xl",
                    title: "text-2xl font-bold text-pink-700 mb-4",
                },
            });
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = "https://iqirktmtuvqoeqrcqcqb.supabase.co";
        const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxaXJrdG10dXZxb2VxcmNxY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDkxNzMsImV4cCI6MjA3NTIyNTE3M30.nbxFIL3sqCnWSaKZl7X2y4KgpUw8UF_JC9_Ago1BQWo";
        const BUCKET_NAME = "weekly-plan"; // Your image storage bucket name
        // --- GLOBAL STATE ---
        // Ensure the current user's ID is available globally after login
        window.currentUserId = window.currentUserId || null;

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM REFERENCES ---
        const userNameEl = document.getElementById("userNameDesktop");
        const outfitGrid = document.getElementById("outfitGrid");
        const outfitGridStatus = document.getElementById("outfitGridStatus");
        const totalOutfitsEl = document.getElementById("totalOutfits");
        const itemsInRotationEl = document.getElementById("itemsInRotation");
        const saveOutfitButton = document.getElementById("saveOutfitButton");
        const pinnedFavoritesSection = document.getElementById(
            "pinnedFavoritesSection"
        );
        const pinnedFavoritesTable = document.getElementById(
            "pinnedFavoritesTable"
        );


        // --- UTILITY FUNCTIONS ---
        function notify(icon, title) {
            Swal.fire({
                icon: icon,
                title: title,
                showConfirmButton: false,
                timer: 2000,
                toast: true,
                position: "top-end",
            });
        }

        window.openOutfitForm = () =>
            document.getElementById("outfitModal").classList.remove("hidden");

        window.closeModal = () => {
            document.getElementById("outfitModal").classList.add("hidden");
            document.getElementById("outfitForm").reset();
        };

        /**
         * Parses a public Supabase URL and deletes the corresponding file from Storage.
         * @param {string} publicUrl - The full public URL of the image.
         */
        async function deleteImage(publicUrl) {
            if (!publicUrl) return;

            // Extract the file path from the public URL. The path is everything after the bucket name and 'public'.
            // e.g., '.../storage/v1/object/public/BUCKET_NAME/path/to/file.jpg' -> 'path/to/file.jpg'
            const urlParts = publicUrl.split('/');
            const publicIndex = urlParts.indexOf('public');

            if (publicIndex === -1 || publicIndex + 2 >= urlParts.length) {
                console.error("Could not parse public URL for deletion:", publicUrl);
                return;
            }

            // path will be: folder/filename.ext
            const path = urlParts.slice(publicIndex + 2).join('/');

            const { error } = await supabase.storage.from(BUCKET_NAME).remove([path]);

            if (error) {
                // Log the error but continue, as the DB deletion is more critical.
                console.error("Storage image deletion failed for path:", path, error.message);
            } else {
                console.log(`Successfully deleted image at path: ${path}`);
            }
        }

        // --- CORE DELETION FUNCTION (Called via the delete button in HTML) ---
        /**
         * Handles the complete process of deleting an outfit: confirmation, 
         * storage file deletion, database record deletion, and UI update.
         * @param {string} outfitId - The UUID of the outfit to delete.
         */
        window.deleteOutfit = async function (outfitId) {
            if (!window.currentUserId) {
                return notify("error", "User not authenticated. Please log in.");
            }

            // 1. CONFIRMATION STEP
            const result = await Swal.fire({
                title: 'Are you sure? 🗑️',
                text: "This will permanently delete the plan and all associated images.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#DB2777', // Darker pink for delete
                cancelButtonColor: '#9CA3AF',
                confirmButtonText: 'Yes, delete it!'
            });

            if (!result.isConfirmed) {
                return; // Stop if the user cancels
            }

            // Find the outfit card to disable the button and for DOM removal
            const cardToRemove = document.getElementById(`outfit-card-${outfitId}`);
            // Temporarily disable the button to prevent double-clicks
            const deleteButton = cardToRemove ? cardToRemove.querySelector(`[onclick*="deleteOutfit('${outfitId}')"]`) : null;
            if (deleteButton) deleteButton.disabled = true;

            try {
                // A. FETCH IMAGE URLS before deleting the main record (important!)
                // We need the URLs to delete from storage BEFORE we delete the row from the DB.
                const { data: outfitData, error: fetchError } = await supabase
                    .from("weekly_outfits")
                    .select("upper_image, pants_image, shoes_image")
                    .eq("id", outfitId)
                    .single();

                if (fetchError || !outfitData) {
                    // This error is NOT critical, we just skip image deletion and proceed to DB delete.
                    console.warn("Could not fetch image URLs for deletion, proceeding with DB record deletion.", fetchError);
                } else {
                    // B. DELETE ASSOCIATED IMAGES FROM STORAGE
                    // Use Promise.allSettled to allow one image deletion to fail without stopping others
                    await Promise.allSettled([
                        deleteImage(outfitData.upper_image),
                        deleteImage(outfitData.pants_image),
                        deleteImage(outfitData.shoes_image),
                    ]);
                }

                // C. DELETE DATA FROM THE `weekly_outfits` TABLE
                // This is the CRITICAL STEP that fails without RLS!
                const { error: deleteError } = await supabase
                    .from("weekly_outfits")
                    .delete()
                    .eq("id", outfitId)
                    .eq("user_id", window.currentUserId); // RLS Check: ensures only the owner can delete

                if (deleteError) {
                    // If the database delete fails (likely RLS issue), throw the error
                    throw deleteError;
                }

                // D. MANUAL DOM REMOVAL (Immediate visual feedback)
                if (cardToRemove) {
                    // Smooth transition effect
                    cardToRemove.style.transition = 'all 0.3s ease-out';
                    cardToRemove.style.opacity = '0';
                    cardToRemove.style.transform = 'scale(0.9) translateY(20px)';

                    // Remove element after the transition is complete
                    setTimeout(() => {
                        cardToRemove.remove();
                    }, 300);
                }

                notify("success", "✅ Outfit plan deleted successfully!");
                // The realtime subscription should refresh stats, but we call loadOutfits
                // as a safety measure to instantly refresh stats/charts/favorites table.
                window.loadOutfits(window.currentUserId);


            } catch (e) {
                // This block executes if the DB deletion failed (most likely RLS denial)
                notify("error", `Deletion Failed: ${e.message || 'Server error.'}\nDid you set your RLS Policy?`);
                console.error("Outfit deletion error:", e);
                // Re-enable the button on failure
                if (deleteButton) deleteButton.disabled = false;
            } finally {
                // No need to re-enable button if card is removed, but for safety on fetch errors:
                if (deleteButton && cardToRemove && cardToRemove.parentElement) {
                    deleteButton.disabled = false;
                }
            }
        };


        // --- USER & AUTH ---
        async function loadUser() {
            const {
                data: { user },
            } = await supabase.auth.getUser();
            if (!user) {
                notify("warning", "Please log in to view your plans.");
                // window.location.href = "../index.html"; // Uncomment for production
                return null;
            }

            const { data: profile, error } = await supabase
                .from("users")
                .select("full_name, id")
                .eq("auth_id", user.id)
                .single();

            if (error || !profile) {
                userNameEl.textContent = "Guest";
                console.error("Profile load error:", error);
                return null;
            }

            userNameEl.textContent = profile.full_name || "User";
            // SET THE GLOBAL USER ID HERE!
            window.currentUserId = profile.id;
            return profile.id;
        }

        // --- STORAGE ---
        async function uploadImage(file, folder) {
            if (!file) return null;

            const fileName = `${folder}/${Date.now()}_${Math.random()
                .toString(36)
                .substring(2, 8)}.${file.name.split(".").pop()}`;

            const { error } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(fileName, file);

            if (error) {
                notify(
                    "error",
                    `Image upload failed for ${folder}: ${error.message}`
                );
                console.error("Upload error:", error.message);
                return null;
            }

            const { data: publicUrl } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(fileName);

            return publicUrl.publicUrl;
        }

        // --- DATA LOADING & RENDERING (Full body of loadOutfits is included for completeness) ---
        window.loadOutfits = async function (userId) {
            if (!userId) return;

            if (outfitGrid.innerHTML === "") {
                outfitGridStatus.innerHTML =
                    '<i class="fa-solid fa-sync fa-spin mr-2 text-pink-500"></i> Fetching real-time plans...';
            }

            const { data: outfits, error } = await supabase
                .from("weekly_outfits")
                .select("*, is_favorite")
                .eq("user_id", userId)
                // 1. Sort by is_favorite descending (TRUE comes first)
                // 2. Then, sort by outfit_date ascending
                .order("is_favorite", { ascending: false })
                .order("outfit_date", { ascending: true });

            if (error) {
                console.error("Error loading outfits:", error.message);
                outfitGridStatus.innerHTML =
                    "<p class='text-red-500'>Error loading outfits.</p>";
                return;
            }

            updateStatsAndChart(outfits);
            renderPinnedFavorites(outfits.filter((o) => o.is_favorite));
            renderOutfitGrid(outfits);
        }

        function renderPinnedFavorites(favorites) {
            if (favorites.length === 0) {
                pinnedFavoritesSection.classList.add("hidden");
                pinnedFavoritesTable.innerHTML = "";
                return;
            }

            pinnedFavoritesSection.classList.remove("hidden");

            const tableHeader = `
                <thead>
                  <tr>
                      <th class="favorite-img-col">Image</th>
                      <th>Date & Name</th>
                      <th>Upper</th>
                      <th>Pants</th>
                      <th>Shoes</th>
                      <th class="text-center">Action</th>
                  </tr>
                </thead>
            `;

            const tableBody = favorites
                .map((outfit) => {
                    const dateStr = new Date(outfit.outfit_date).toDateString();
                    const mainImageUrl =
                        outfit.upper_image || outfit.pants_image || outfit.shoes_image;

                    return `
                    <tr>
                        <td>
                            ${mainImageUrl
                            ? `<img src="${mainImageUrl}" 
                                       class="w-10 h-10 object-cover rounded-md cursor-pointer" 
                                       alt="${outfit.outfit_name} Image"
                                       onclick="viewLargeImage('${mainImageUrl}', 'Pinned: ${outfit.outfit_name}')"
                                      >`
                            : '<i class="fa-solid fa-thumbtack text-pink-500 text-xl"></i>'
                        }
                        </td>
                        <td>
                            <p class="font-bold text-gray-800">${outfit.outfit_name
                        }</p>
                            <p class="text-xs text-gray-500">${dateStr}</p>
                        </td>
                        <td class="text-sm text-gray-700">${outfit.upper_desc || "-"
                        }</td>
                        <td class="text-sm text-gray-700">${outfit.pants_desc || "-"
                        }</td>
                        <td class="text-sm text-gray-700">${outfit.shoes_desc || "-"
                        }</td>
                        <td class="text-center">
                            <button class="unfavorite-btn-table" onclick="toggleFavorite('${outfit.id
                        }', true)">
                                <i class="fa-solid fa-heart-crack mr-1"></i> Unfavorite
                            </button>
                        </td>
                    </tr>
                `;
                })
                .join("");

            pinnedFavoritesTable.innerHTML =
                tableHeader + `<tbody>${tableBody}</tbody>`;
        }

        async function setupRealtimeSubscription(userId) {
            const channelName = `outfit_changes_${userId}`;
            // Ensure to remove existing channel to prevent duplicate listeners
            // Supabase client automatically handles channels, but explicit removal can be safer
            const existingChannel = supabase.getChannels().find(c => c.topic === `public:weekly_outfits:user_id=eq.${userId}`);
            if (existingChannel) {
                await supabase.removeChannel(existingChannel);
            }

            const channel = supabase.channel(channelName);

            channel
                .on(
                    "postgres_changes",
                    {
                        event: "*",
                        schema: "public",
                        table: "weekly_outfits",
                        filter: `user_id=eq.${userId}`,
                    },
                    (payload) => {
                        console.log("Real-time update received:", payload.eventType);
                        // Call loadOutfits to re-fetch and re-render
                        loadOutfits(userId);

                        // Only show notification for insert 
                        // (delete is handled inside deleteOutfit, update/favorite is handled inside toggleFavorite)
                        if (payload.eventType === "INSERT") {
                            notify("success", "🆕 New plan added!");
                        }
                    }
                )
                .subscribe();
            console.log("Supabase Realtime subscription active.");
        }

        function renderOutfitGrid(data) {
            outfitGrid.innerHTML = "";
            outfitGridStatus.innerHTML = "";

            // Filter out pinned items from the main grid view
            const unpinnedData = data.filter((o) => !o.is_favorite);

            if (!data || data.length === 0) {
                outfitGridStatus.innerHTML = `
                <p class='text-gray-500 mt-4 col-span-full'>
                    <i class="fa-solid fa-box-open text-pink-500 mr-2"></i> No outfits planned yet. Click "Add New Outfit Plan" to start!
                </p>`;
                return;
            }

            // Render unpinned items in the main grid
            outfitGrid.innerHTML = unpinnedData
                .map(
                    (outfit) => `
                    <div id="outfit-card-${outfit.id}" class="card glass p-4 rounded-xl shadow-lg hover:shadow-xl transition relative flex flex-col justify-between" data-aos="fade-up">
                        
                        <button class="action-btn delete-btn" title="Delete Plan" onclick="deleteOutfit('${outfit.id
                        }')">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                        <button class="action-btn" style="right: 50px;" title="Pin as Favorite" onclick="toggleFavorite('${outfit.id
                        }', false)">
                            <i class="fa-regular fa-heart"></i>
                        </button>
                        
                        <div>
                            <div class="flex items-center text-sm text-gray-500 mb-2">
                                <i class="fa-solid fa-calendar-alt mr-2 text-pink-500"></i> 
                                <span class="font-medium">${new Date(
                            outfit.outfit_date
                        ).toDateString()}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-3">${outfit.outfit_name
                        }</h3>
                            
                            <div class="space-y-2"> ${renderItem(
                            "Upper",
                            outfit.upper_desc,
                            outfit.upper_image,
                            "shirt"
                        )}
                                ${renderItem(
                            "Pants",
                            outfit.pants_desc,
                            outfit.pants_image,
                            "person"
                        )}
                                ${renderItem(
                            "Shoes",
                            outfit.shoes_desc,
                            outfit.shoes_image,
                            "shoe-prints"
                        )}
                            </div>
                        </div>
                    </div>
                    `
                )
                .join("");
        }

        function renderItem(type, desc, image, icon) {
            if (!desc && !image) return "";

            return `
                <div class="item-flex-container bg-white rounded-lg border border-gray-100">
                    <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden border border-pink-100">
                        ${image
                    ? `<img src="${image}" 
                                   class="item-image w-full h-full object-cover" 
                                   alt="${type} - ${desc || "Image"}"
                                   onclick="viewLargeImage('${image}', '${type} - ${desc || "Image"
                    }')"
                                  >`
                    : `<div class="item-icon-box w-full h-full flex items-center justify-center">
                                    <i class="fa-solid fa-${icon} text-lg"></i>
                                </div>`
                }
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="text-xs font-semibold text-pink-600 truncate">${type}</p>
                        <p class="text-sm text-gray-700 truncate" title="${desc || "No description"
                }">${desc || `No description`}</p>
                    </div>
                </div>
            `;
        }

        let outfitLineChartInstance = null;
        function updateStatsAndChart(outfits) {
            totalOutfitsEl.textContent = outfits.length;

            let items = [];
            let dailyCounts = {
                Mon: 0,
                Tue: 0,
                Wed: 0,
                Thu: 0,
                Fri: 0,
                Sat: 0,
                Sun: 0,
            };
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            outfits.forEach((o) => {
                // Track items for rotation count
                if (o.upper_desc) items.push(o.upper_desc.toLowerCase().trim());
                if (o.pants_desc) items.push(o.pants_desc.toLowerCase().trim());
                if (o.shoes_desc) items.push(o.shoes_desc.toLowerCase().trim());

                // Track plans per day for the chart
                try {
                    const date = new Date(o.outfit_date);
                    // Get the day of the week (0=Sun, 1=Mon, ...)
                    const dayIndex = date.getDay();
                    const dayKey = dayNames[dayIndex];
                    dailyCounts[dayKey]++;
                } catch (e) {
                    console.warn("Invalid date in outfit data:", o.outfit_date);
                }
            });

            const uniqueItems = new Set(items.filter((item) => item !== "")); // Filter out empty strings
            itemsInRotationEl.textContent = uniqueItems.size;

            const seriesData = Object.values(dailyCounts);
            const categories = Object.keys(dailyCounts);

            const chartOptions = {
                series: [
                    {
                        name: "Outfits Planned",
                        data: seriesData,
                    },
                ],
                chart: {
                    id: "outfitLineChartInstance", // Unique ID for updating
                    type: "line",
                    height: 280,
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                colors: ["#EC4899"], // Pink color theme
                stroke: {
                    curve: "smooth",
                    width: 4,
                },
                markers: {
                    size: 6,
                    colors: ["#DB2777"],
                    strokeColors: "#fff",
                    strokeWidth: 2,
                    hover: {
                        size: 8,
                    },
                },
                xaxis: {
                    categories: categories,
                    title: {
                        text: "Day of the Week",
                        style: {
                            color: "#888",
                            fontWeight: 600,
                        },
                    },
                    labels: {
                        style: {
                            colors: "#555",
                            fontSize: "12px",
                        },
                    },
                },
                yaxis: {
                    title: {
                        text: "Number of Outfits",
                        style: {
                            color: "#888",
                            fontWeight: 600,
                        },
                    },
                    labels: {
                        style: {
                            colors: "#555",
                        },
                        formatter: function (val) {
                            return val.toFixed(0);
                        },
                    },
                    min: 0,
                    tickAmount: Math.max(2, ...seriesData), // Ensures at least 2 ticks
                },
                grid: {
                    borderColor: '#f0f0f0',
                    row: {
                        colors: ['#fff', '#f9f9f9'],
                        opacity: 0.5
                    },
                },
                tooltip: {
                    theme: 'light',
                }
            };

            if (outfitLineChartInstance) {
                // If chart exists, update its series data
                ApexCharts.exec("outfitLineChartInstance", 'updateOptions', chartOptions);
            } else {
                // Otherwise, create the chart
                const chartEl = document.querySelector("#outfitChart");
                if (chartEl) {
                    outfitLineChartInstance = new ApexCharts(chartEl, chartOptions);
                    outfitLineChartInstance.render();
                }
            }
        }


        // --- DATA SUBMISSION ---
        window.saveOutfit = async function () {
            if (!window.currentUserId) {
                return notify("error", "Please log in to save your plan.");
            }

            const date = document.getElementById("date").value;
            const name = document.getElementById("name").value.trim();
            const upperDesc = document.getElementById("upperDesc").value.trim();
            const pantsDesc = document.getElementById("pantsDesc").value.trim();
            const shoesDesc = document.getElementById("shoesDesc").value.trim();

            if (!date || !name) {
                return notify("warning", "Date and Outfit Name are required!");
            }

            saveOutfitButton.disabled = true;
            saveOutfitButton.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...`;

            try {
                // 1. Upload Images
                const upperImageFile = document.getElementById("upperImage").files[0];
                const pantsImageFile = document.getElementById("pantsImage").files[0];
                const shoesImageFile = document.getElementById("shoesImage").files[0];

                const [upperUrl, pantsUrl, shoesUrl] = await Promise.all([
                    uploadImage(upperImageFile, "upper"),
                    uploadImage(pantsImageFile, "pants"),
                    uploadImage(shoesImageFile, "shoes"),
                ]);

                // 2. Insert Record
                const { error } = await supabase.from("weekly_outfits").insert([
                    {
                        user_id: window.currentUserId,
                        outfit_date: date,
                        outfit_name: name,
                        upper_desc: upperDesc,
                        upper_image: upperUrl,
                        pants_desc: pantsDesc,
                        pants_image: pantsUrl,
                        shoes_desc: shoesDesc,
                        shoes_image: shoesUrl,
                    },
                ]);

                if (error) throw error;

                closeModal();
                // Realtime subscription handles the notify("success") and loadOutfits
            } catch (e) {
                notify("error", `Failed to save plan: ${e.message}`);
                console.error("Save outfit error:", e);
            } finally {
                saveOutfitButton.disabled = false;
                saveOutfitButton.innerHTML = `<i class="fa-solid fa-save"></i> Save Outfit Plan`;
            }
        };

        // --- FAVORITE TOGGLE ---
        window.toggleFavorite = async function (outfitId, isCurrentlyFavorite) {
            if (!window.currentUserId) {
                return notify("error", "User not authenticated. Please log in.");
            }

            const newFavoriteState = !isCurrentlyFavorite;
            const action = newFavoriteState ? "Pinning" : "Unpinning";
            const successMsg = newFavoriteState ? "✨ Pinned as Favorite!" : "💔 Unpinned.";

            try {
                const { error } = await supabase
                    .from("weekly_outfits")
                    .update({ is_favorite: newFavoriteState })
                    .eq("id", outfitId)
                    .eq("user_id", window.currentUserId); // RLS/security check

                if (error) throw error;

                notify("info", successMsg);
                // The realtime subscription will trigger a full list refresh
            } catch (e) {
                notify("error", `${action} failed: ${e.message}`);
                console.error(`${action} error:`, e);
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", async () => {
            const userId = await loadUser();
            if (userId) {
                await loadOutfits(userId);
                setupRealtimeSubscription(userId);
            }
        });

    </script>
</body>

</html>
